---
title: "preprocessing"
author: "Jin Lin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load R Packages

```{r packages,eval=FALSE, message=FALSE}
library(tidyverse)
library(flowCore)
library(flowClust)
library(ggcyto)
library(gridExtra)
library(knitr)
```

## Import Data

```{r pressure, eval=FALSE}
fcs.direction <- "~/FCS/Z-Project Bacillus_pretest/fcs"
z_fs <- read.flowSet(path = fcs.direction,alter.names = T)
z_gate <- read.FCS("~/FCS/Z-Project Bacillus_pretest/Gating.fcs",alter.names = T)
```

Now, let's have a look of variables, and their corresponding notations.

```{r}
markernames(z_fs[[1]])
```

### Basic Visualization

We select FSC, which represents the cell size and the fluorescence with a wavelength of 460 nm to generate the raw scatter plot.

```{r, message=FALSE}
ggplot(z_fs[[1]],aes(x=`PMT.1`,y=`PMT.9`))+
  geom_hex(bins=100)+
  theme_bw()+
  labs(x="FSC",y="Fluorescence",title = "FSC vs Fluoresence",subtitle = "Inner_zone_DAPI")+
  xlim(0,2500)+ylim(0,2500)+coord_fixed()
```

Clearly, the particles are concentrated in the left bottom area, it indicates that before any further downstream analysis, a proper transformation of the data is necessary.

## Compensation + Transformation

In this section, we take one flowFrame, the Inner_Zone_DAPI, of whole flowSet as an example to illustrate the effect of compensation and transformation.

```{r,eval=FALSE}
# Compensation
y_comp <- compensate(z_fs[[1]],spillover(z_fs[[1]])$SPILL)

# Cleaning
library(flowAI)
y_comp_clean <- flow_auto_qc(y_comp)
```

```{r}
# Transformation using log-transformation
trans <- estimateLogicle(y_comp_clean,colnames(y_comp_clean[,c(11,27)]))
y_comp_clean_trans <- transform(y_comp_clean,trans)

ggplot(y_comp_clean_trans,aes(x=`PMT.1`,y=`PMT.9`))+
  geom_hex(bins=100)+
  theme_bw()+
  labs(x="FSC",y="Fluo.",title = "FSC vs Fluo. after log-transformation",subtitle = "Inner_zone_DAPI")

```

```{r}
# Clustering by robust model-based method
y_gate <- flowClust(y_comp_clean_trans,varNames=c("PMT.1","PMT.2"), K=1,B=100)

y_comp_clean_trans2 <- y_comp_clean_trans[y_comp_clean_trans %in% y_gate,]
y_gate2 <- flowClust(y_comp_clean_trans2, varNames = c("PMT.1","PMT.9"),
                     K=1:6,B=100)

criterion(y_gate2,"BIC")
summary(y_gate2[[3]]) #K=3

# Set outlier standard: 95% quantile
ruleOutliers(y_gate2[[3]]) <- list(level=0.95)
summary(y_gate2[[3]])

plot(y_gate2[[3]],data=y_comp_clean_trans2,level=0.8)
```
